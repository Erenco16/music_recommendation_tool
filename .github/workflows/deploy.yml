- name: SSH into EC2 and Deploy
  uses: appleboy/ssh-action@v0.1.6
  with:
    host: ${{ secrets.EC2_INSTANCE_IP }}
    username: ${{ secrets.EC2_USER }}
    key: ${{ secrets.EC2_SSH_KEY }}
    script: |
      echo "Logging into AWS ECR from EC2..."
      aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com

      echo "Stopping and removing existing container (if any)..."
      docker stop flask_server || true
      docker rm -f flask_server || true  # Force remove the container

      echo "Removing old Docker images to free up space..."
      docker system prune -af || true

      echo "Pulling latest Docker image from ECR..."
      docker pull ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest

      echo "Starting new container..."
      docker run -d --name flask_server -p 5001:5001 \
        ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com/${{ secrets.ECR_REPOSITORY }}:latest

      echo "Deployment complete!"
